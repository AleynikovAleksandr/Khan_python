from sqlalchemy import Column, Integer, String, DECIMAL, ForeignKey
from sqlalchemy.orm import relationship
from database_config import DatabaseConfig
from sqlalchemy.exc import IntegrityError

# ===========================
#  НАСТРОЙКА БАЗЫ
# ===========================
Base = DatabaseConfig.Base
session = DatabaseConfig.SessionLocal()

# ===========================
#  МОДЕЛИ
# ===========================
class Ingredient(Base):
    __tablename__ = "ingredient"
    ingredient_id = Column(Integer, primary_key=True, autoincrement=True)
    ingredient_name = Column(String(100), nullable=False, unique=True)
    compositions = relationship("Composition", back_populates="ingredient")


class MenuItem(Base):
    __tablename__ = "menu_item"
    menu_item_id = Column(Integer, primary_key=True, autoincrement=True)
    menu_name = Column(String(100), nullable=False)
    weight = Column(DECIMAL(10, 2), nullable=False)
    price = Column(DECIMAL(10, 2), nullable=False)
    compositions = relationship("Composition", back_populates="menu_item")


class Composition(Base):
    __tablename__ = "composition"
    ingredient_id = Column(Integer, ForeignKey("ingredient.ingredient_id"), primary_key=True)
    menu_item_id = Column(Integer, ForeignKey("menu_item.menu_item_id"), primary_key=True)
    ingredient = relationship("Ingredient", back_populates="compositions")
    menu_item = relationship("MenuItem", back_populates="compositions")


# ===========================
#  СОЗДАНИЕ ТАБЛИЦ
# ===========================
Base.metadata.create_all(DatabaseConfig.engine)

# ===========================
#  ИНГРЕДИЕНТЫ
# ===========================
ingredients_list = [
    "Куриные грудки", "Чеснок", "Оливковое масло", "Помидоры черри", "Прованские травы",
    "Треска", "Морковь", "Лук", "Сельдерей", "Картофель", "Лавровый лист",
    "Баклажаны", "Кабачки", "Перец", "Помидоры", "Сметана", "Говядина", 
    "Говяжий фарш", "Паста", "Сыр", "Сухарики", "Мед", "Соевый соус",
    "Каперсы", "Сливки", "Брокколи", "Цветная капуста", "Тыква", "Семга", 
    "Шоколад", "Ваниль", "Желатин", "Ягоды", "Пармезан", "Моцарелла", "Кукуруза",
    "Горошек", "Лосось", "Творог", "Йогурт", "Мята", "Корица", "Кардамон", "Имбирь", "Соус Терияки",
    "Листья салата", "Огурцы", "Оливки", "Сыр фета", "Соль", "Яйцо", "Тарталетки", "Майонез",
    "Сухари", "Мука", "Масло", "Лимон", "Хлеб", "Базилик", "Креветки", "Галангаль", "Лемонграсс", "Карри", "Рис"
]

ingredient_objects = [Ingredient(ingredient_name=i) for i in ingredients_list]
try:
    session.bulk_save_objects(ingredient_objects)
    session.commit()
except IntegrityError:
    session.rollback()  # если ингредиенты уже есть

# ===========================
#  БЛЮДА
# ===========================
dishes_list = [
    ("Курица по-провански", 450, 900),
    ("Рыбный суп Морской бриз", 300, 750),
    ("Овощное рагу", 350, 650),
    ("Говядина по-строгановски", 400, 1200),
    ("Лазанья с мясом", 500, 1300),
    ("Салат Цезарь", 250, 600),
    ("Салат Греческий", 200, 550),
    ("Картофель фри", 150, 300),
    ("Куриные крылышки медово-чесночные", 350, 700),
    ("Тартар из говядины", 150, 950),
    ("Паста Альфредо", 400, 1000),
    ("Овощной суп-пюре", 250, 500),
    ("Тыквенный крем-суп", 250, 550),
    ("Стейк из семги", 300, 1500),
    ("Мясное ассорти", 1200, 2000),
    ("Шоколадный фондан", 120, 400),
    ("Панна котта", 150, 350),
    ("Куриное карри", 400, 950),
    ("Суп с морепродуктами", 300, 1200),
    ("Рататуй", 350, 700),
    ("Том Ям", 300, 850),
    ("Пицца Маргарита", 450, 1000),
    ("Пицца Пепперони", 500, 1100),
    ("Феттучини с грибами", 400, 950),
    ("Салат с авокадо", 200, 650),
    ("Тарталетки с креветками", 150, 700),
    ("Куриный шницель", 350, 900),
    ("Медальоны из свинины", 300, 950),
    ("Рыба на пару", 350, 1200),
    ("Крем-суп из шпината", 250, 500),
    ("Брускетта с томатами", 150, 400),
    ("Гаспачо", 200, 450),
    ("Севиче", 180, 950),
    ("Омлет с овощами", 200, 350),
    ("Фаршированные перцы", 300, 800),
    ("Курица терияки", 400, 950),
    ("Лосось гриль", 350, 1500),
    ("Морковный торт", 150, 400),
    ("Яблочный пирог", 200, 350),
    ("Мятный шоколадный мусс", 150, 450),
    ("Сырники", 200, 300)
]

menu_objects = [MenuItem(menu_name=name, weight=weight, price=price) for name, weight, price in dishes_list]
session.bulk_save_objects(menu_objects)
session.commit()

# ===========================
#  СОСТАВ БЛЮД
# ===========================
dish_ingredients = {
    "Курица по-провански": ["Куриные грудки", "Чеснок", "Оливковое масло", "Помидоры черри", "Прованские травы"],
    "Рыбный суп Морской бриз": ["Треска", "Морковь", "Лук", "Сельдерей", "Картофель", "Лавровый лист"],
    "Овощное рагу": ["Баклажаны", "Кабачки", "Перец", "Помидоры", "Лук", "Чеснок", "Оливковое масло"],
    "Говядина по-строгановски": ["Говядина", "Лук", "Сметана", "Чеснок", "Перец"],
    "Лазанья с мясом": ["Говяжий фарш", "Лук", "Чеснок", "Томатная паста", "Паста", "Сыр"],
    "Салат Цезарь": ["Куриные грудки", "Листья салата", "Пармезан", "Сухарики", "Оливковое масло", "Чеснок"],
    "Салат Греческий": ["Помидоры", "Огурцы", "Перец", "Оливки", "Сыр фета", "Оливковое масло"],
    "Картофель фри": ["Картофель", "Соль", "Оливковое масло"],
    "Куриные крылышки медово-чесночные": ["Куриные грудки", "Мед", "Чеснок", "Соевый соус", "Перец"],
    "Тартар из говядины": ["Говядина", "Лук", "Каперсы", "Оливковое масло", "Яйцо"],
    "Паста Альфредо": ["Паста", "Сливки", "Пармезан", "Чеснок", "Куриные грудки"],
    "Овощной суп-пюре": ["Брокколи", "Цветная капуста", "Морковь", "Картофель", "Сливки"],
    "Тыквенный крем-суп": ["Тыква", "Лук", "Сливки", "Морковь", "Масло сливочное"],
    "Стейк из семги": ["Семга", "Лимон", "Оливковое масло", "Специи"],
    "Мясное ассорти": ["Свиная шейка", "Говядина", "Курица", "Копчёные колбаски", "Специи"],
    "Шоколадный фондан": ["Шоколад", "Яйцо", "Сливочное масло", "Сахар", "Мука"],
    "Панна котта": ["Сливки", "Сахар", "Ваниль", "Желатин", "Ягоды"],
    "Куриное карри": ["Куриные грудки", "Карри", "Чеснок", "Лук", "Сливки"],
    "Суп с морепродуктами": ["Лосось", "Треска", "Морковь", "Сельдерей", "Картофель", "Лавровый лист"],
    "Рататуй": ["Баклажаны", "Кабачки", "Помидоры", "Перец", "Лук", "Чеснок", "Оливковое масло"],
    "Том Ям": ["Креветки", "Лайм", "Лук", "Чеснок", "Галангаль", "Лемонграсс"],
    "Пицца Маргарита": ["Паста", "Помидоры", "Моцарелла", "Оливковое масло", "Базилик"],
    "Пицца Пепперони": ["Паста", "Помидоры", "Моцарелла", "Пепперони", "Оливковое масло"],
    "Феттучини с грибами": ["Паста", "Грибы", "Сливки", "Чеснок", "Пармезан"],
    "Салат с авокадо": ["Авокадо", "Листья салата", "Помидоры", "Огурцы", "Оливковое масло"],
    "Тарталетки с креветками": ["Креветки", "Тарталетки", "Майонез", "Лимон"],
    "Куриный шницель": ["Куриные грудки", "Сухари", "Яйцо", "Мука", "Масло"],
    "Медальоны из свинины": ["Свиная шейка", "Чеснок", "Соль", "Перец", "Оливковое масло"],
    "Рыба на пару": ["Лосось", "Лимон", "Специи", "Оливковое масло"],
    "Крем-суп из шпината": ["Шпинат", "Сливки", "Лук", "Чеснок", "Масло"],
    "Брускетта с томатами": ["Хлеб", "Помидоры", "Чеснок", "Оливковое масло", "Базилик"],
    "Гаспачо": ["Помидоры", "Огурцы", "Перец", "Лук", "Чеснок", "Оливковое масло"],
    "Севиче": ["Лосось", "Лайм", "Лук", "Перец", "Кинза"],
    "Омлет с овощами": ["Яйцо", "Молоко", "Помидоры", "Перец", "Лук"],
    "Фаршированные перцы": ["Перец", "Говяжий фарш", "Рис", "Лук", "Томатная паста"],
    "Курица терияки": ["Куриные грудки", "Соус Терияки", "Чеснок", "Имбирь", "Мед"],
    "Лосось гриль": ["Лосось", "Лимон", "Оливковое масло", "Специи"],
    "Морковный торт": ["Морковь", "Мука", "Яйцо", "Сахар", "Корица"],
    "Яблочный пирог": ["Яблоки", "Мука", "Яйцо", "Сахар", "Ваниль"],
    "Мятный шоколадный мусс": ["Шоколад", "Сливки", "Мята", "Сахар", "Яйцо"],
    "Сырники": ["Творог", "Яйцо", "Мука", "Сахар", "Масло"]
}

composition_objects = []
for dish_name, ingredients_names in dish_ingredients.items():
    menu_item = session.query(MenuItem).filter_by(menu_name=dish_name).first()
    if menu_item:
        for ing_name in ingredients_names:
            ingredient = session.query(Ingredient).filter_by(ingredient_name=ing_name).first()
            if ingredient:
                composition_objects.append(
                    Composition(menu_item_id=menu_item.menu_item_id, ingredient_id=ingredient.ingredient_id)
                )

session.bulk_save_objects(composition_objects)
session.commit()

# ===========================
#  ВЫВОД ВСЕХ ТАБЛИЦ
# ===========================
print("=== INGREDIENTS ===")
for ing in session.query(Ingredient).all():
    print(f"{ing.ingredient_id}: {ing.ingredient_name}")

print("\n=== MENU ITEMS ===")
for menu in session.query(MenuItem).all():
    print(f"{menu.menu_item_id}: {menu.menu_name} ({menu.weight} г) - {menu.price} ₽")

print("\n=== COMPOSITION ===")
for comp in session.query(Composition).all():
    print(f"MenuItem ID {comp.menu_item_id} - Ingredient ID {comp.ingredient_id}")

session.close()
print("\nДанные успешно сгенерированы!")
